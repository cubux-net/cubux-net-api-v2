Синхронизация счёта с реальным банком
=====================================

Основные моменты:

*   Установить связь счёта с реальным банком можно только в момент
    создания счёта.
*   Для установления связи, получения разрешений и т.п. в большинстве
    случаев требуется наличие интернет соединения между пользователем и
    банком. Поэтому операция подключения счёта в общем случае возможна
    только в реальном времени без основного АПИ синхронизации приложения
    с сервером.
*   В зависимости от банка автоматическое обновление данных на счету
    может быть либо доступно с временнЫми ограничениями, либо
    отсутствовать (обновление только по запросу пользователя (refresh,
    см. ниже), также с временнЫми ограничениями).
*   Нельзя использовать счёт, синхронизированный с банком, в обычных
    транзакциях и других объектах, которые может приводить к созданию
    транзакций на указанном счету.
*   Авторизация на доступ к данным в банке может перестать быть
    актуальной. В этом случае пользователь может попытаться выполнить
    обновление данных авторизации (reconnect, см. ниже).
*   Можно прекратить синхронизацию счёта с банком (revoke, см. ниже).
*   Данные авторизации с банком на нашем сервере привязаны к конкретному
    пользователю, поэтому запросы [`reconnect`][api-reconnect],
    [`refresh`][api-refresh] и [`view`][api-view] может выполнять только
    пользователь, который эти данные создал запросом
    [`create`][api-create].
*   При повторном подключении одним и тем же пользователем одних и тех
    же данных авторизации (запрос [`create`][api-create]) сервер _может_
    использовать уже существующие на сервере данные для оптимизации
    сетевого траффика и времени выполнения. Для пользователя это не
    должно вызвать никаких негативных побочных эффектов.

## API

*   [`init`][api-init] — описание действия для подключения
*   [`create`][api-create] — создание логина
*   [`interactive-form`][api-interactive-form] — описание интерактивной
    формы
*   [`interactive-continue`][api-interactive-continue] — отправка
    интерактивной формы
*   [`reconnect`][api-reconnect] — обновление данных аутентификации
*   [`refresh`][api-refresh] — обновление данных
*   [`view`][api-view] — просмотр данных логина


## Общий алгоритм подключения счёта к банку (connect)

1.  Запрос [`init`][api-init].
2.  Действия пользователя: авторизация в банке (OAuth2) или заполнение
    формы.
    *   OAuth2 может быть использован только в web окружении (браузер).
        Этот способ пока оставлен недокументированным до востребования.
        В конце этого шага пользователь возвращается на страницу в
        домене `cubux.net`, откуда данные результата авторизации OAuth2
        передаются на исходную страницу, запросившую авторизацию.
    *   В случае с формой, пользователь просто заполняет форму,
        описанную в результатах запроса из предыдущего шага.
3.  Данные из предыдущего шага отправляются на сервер запросом
    [`create`][api-create].
4.  Если в ответе обозначено, что возник интерактивный шаг, то:
    1.  Необходимо запросить интерактивную форму
        [`interactive-form`][api-interactive-form].
    2.  Пользователь заполняет форму.
    3.  Отправить данные формы запросом
        [`interactive-continue`][api-interactive-continue].
    4.  По результатам вернуться на шаг 4.
5.  В данных ответа имеем список доступных счётов из АПИ банка. Для
    каждого из этих счетов пользователь может отредактировать название,
    или исключить счёт из списка.
6.  Для каждого из оставшихся счетов создаётся счет
    [`Cubux.Account`][Cubux.Account] с соответствующим названием и UUID
    счёта банка в поле `auth_uuid`.

## Обновление данных авторизации (reconnect)

Алгоритм идентичен алгоритму подключения (connect), описанному выше, но
на шаге 3 _вместо_ запроса [`create`][api-create] используется запрос
[`reconnect`][api-reconnect].


## Обновление данных (refresh)


## Отмена синхронизации счёта с банком (revoke)


[api-create]: ./create.md
[api-init]: ./init.md
[api-interactive-continue]: ./interactive-continue.md
[api-interactive-form]: ./interactive-form.md
[api-reconnect]: ./reconnect.md
[api-refresh]: ./refresh.md
[api-view]: ./view.md
[Cubux.Account]: ../type/team/account.md
