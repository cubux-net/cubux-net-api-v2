Ход сеанса синхронизации
========================

Итак, приложению необходимо выполнить один из
[Сценарии синхронизации][scenarios]. Для этого необходимо выполнить
определенные АПИ запросы в определённом порядке.

Построение данных для ответов на запросы и применение принятых изменений
на сервере выполняется асинхронно. В этом случае ответ на основной АПИ
запроса будет нести [тикет][ticket], с помощью которого можно будет
получить настоящий результат позже отдельным АПИ запросом.

Однако, данные для ответов кешируются на сервере, когда это имеет смысл,
благодаря чему ответные данные могут оказаться уже подготовлены заранее
при постеплении основного запроса данных. В этом случае вместо тикета
ответ на запрос будет нести готовые данные.

Ниже приведён алгоритм выполнения АПИ запросов для выполнения одного
любого [сценария синхронизации][scenarios]. Здесь "**Готово**" означает
_успешное завершение_ алгоритма, а "**Отказ**" означает _завершение с
ошибками_.

*   (1) Основной АПИ запрос согласно сценарию:
    [запрос снапшота][api-snapshot], [запрос разницы][api-diff] или
    [отправка изменений][api-submit]. Проверить код HTTP ответа.

    *   (200) Только для запросов получения данных. Готовые данные взяты
        из кеша на сервере. В теле HTTP ответа содержится объект
        [`Cubux.Sync.Response`][Cubux.Sync.Response] с искомыми данными.
        **Готово.**
    *   (202) Обработка поставлена в очередь. В теле ответа содержится
        объект [`Cubux.Sync.Response`][Cubux.Sync.Response] с
        [тикетом][ticket] `T`. Тикет используется далее.
    *   (204) Только при [запрос разницы][api-diff]. Изменений нет. Тело
        ответа пустое. **Готово.**
    *   (304) Только для запросов получения данных с использованием HTTP
        кеширования. Изменений нет, данные в HTTP кеше клиента
        актуальны. Тело ответа пустое. **Готово.**
    *   (410) Только при [запрос разницы][api-diff]. Базовая ревизия
        слишком старая. **Отказ** - необходимо производить
        [запрос снапшота][api-snapshot] вместо этого.
    *   (422) Только при [отправке изменений][api-submit]. Отправленый
        пакет отклонён, т.к. имеет ошибки по вине разработчика клиента.
        **Отказ**.
    *   (5xx) **Отказ**. Обработка согласно [спецификации HTTP][http].

*   (2) Ожидание завершения обработки тикета `T`. Ожидание возможно
    организовать любым из нижеперечисленых способов. Ошибочные HTTP
    статусы ответов на запрос тикета обрабатывать согласно
    [спецификации HTTP][http].

    *   (a) Только для [личных данных пользователя][context-user] и
        [данных команды][context-team].
        Ожидать уведомление от [центрифуги][centrifuge] по каналу
        пользователя (для личных данных) или по каналу команду (для данных
        команды). После получения уведомления выполнить
        [запрос тикета][api-ticket]. Ответ содержит объект
        [`Cubux.Sync.Response`][Cubux.Sync.Response] `R`, где содержится
        обновленный объект тикета `T1`.

    *   (b) Выждать таймаут (лучше рандомный с долями секунд) около
        1—3 секунд и выполнить [запрос тикета][api-ticket]. Ответ
        содержит объект [`Cubux.Sync.Response`][Cubux.Sync.Response]
        `R`, где содержится объект тикета (возможно, обновленный) `T1`.
        Проверить статус `status` тикета `T1`. Если тикет еще не
        завершен (`"new"`, `"work"`), повторить этот пунтк с ожидания.

*   (3) Проверить статус `status` тикета `T1`:

    *   Если тикет завершен успешно (`"done"`), (при этом, если
        начальным запросом (1) был запрос данных, объект ответа `R`
        содержит искомые данные), то **Готово**.
    *   Если тикет был отклонён (`"aborted"`), то **Отказ**. Объект
        тикета `T1` содержит информацию об ошибках. Ошибки
        пользователя _следует_ показать пользователю согласно ТЗ
        клиента. Ошибки разработчика _рекомендуется_ так или иначе
        довести до сведения разработчика клиента.
    *   Иначе (`"failed"`) возникла ошибка при обработке тикета
        сервером. **Отказ**. Необходимо разбираться с техподдержкой
        АПИ сервере. Возможно, начальный запрос (1) можно повторить
        позже без особых изменений.


[api-diff]: api/diff.md
[api-snapshot]: api/snapshot.md
[api-submit]: api/submit.md
[api-ticket]: api/ticket.md
[centrifuge]: ../centrifuge/README.md
[context-team]: context/team.md
[context-user]: context/user.md
[scenarios]: 03-scenarios.md
[ticket]: ...
[Cubux.Sync.Response]: ../type/sync/response.md
[http]: https://tools.ietf.org/html/rfc7231
