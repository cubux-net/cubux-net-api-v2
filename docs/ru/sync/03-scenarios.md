Сценарии сеансов синхронизации
==============================

Возможен ряд ситуация на стороне клиента, в каждой из которых более
пригоден тот или иной сценарий взаимодействия с сервером.

Для _выполнения_ любого из сценариев сеанса рекомендуется следовать
алгоритму, описанному далее в "[Ходе сеанса синхронизации][workflow]".

### Локальная база пуста, неактуальна или повреждена

Необходимо [запросить снапшот][api-snapshot] данных в нужном
[контексте][context].

Например, при первом запуске приложения потребуется:

1.  Запросить снапшот глобальных данных.
2.  Авторизация пользователя.
3.  Здесь уже может потребоваться [запрос разницы][api-diff] по
    глобальным данным.
4.  Запросить снапшот личных данных пользователя.
5.  Запросить снапшот хотя бы одной команды, которая выбрана
    (пользователем или автоматически) в пользовательском интерфейсе
    клиента.

### Нет локальных изменений, но есть прошлый снапшот

Полный снапшот данных уже запрашивался ранее, но после этого
пользователь не вносил локальных изменений.

Если дата создания прошлого снапшота не превышает срока давности (см.
[ограничения][limits]), можно [запросить разницу][api-diff]. В противном
случае необходимо [запросить снапшот][api-snapshot].

### Есть локальные изменения

Если есть локальные изменения, значит ранее уже был получен снапшот.

Поскольку внесение изменений пользователем обычно занимает время,
полагается, что после получения последнего снапшота на сервере также
могли произойти изменения в данных.

1.  Необязательно. Если последняя синхронизация по данному контексту была
    достаточно давно, [запросить разницу][api-diff], выполнить слияние
    изменений (с участием или без участия пользователя согласно ТЗ для
    клиента).

    Если последняя синхронизация по данному контексту проводилась
    настолько давно, что запрос разницы уже невозможен, то возникает
    ситуация, когда необходимо [запросить снапшот][api-snapshot], и при
    этом не утратить локальные изменения пользователя.

2.  Отправить локальные изменения на сервер.
    1.  Если изменения применены сервером успешно, то
        [запросить разницу][api-diff]. Эта разница будет содержать в том
        числе и только что отправленные изменения этим же клиентом.
    2.  Если изменения были отклонены, провести анализ ошибок. Ошибки
        пользователя показать ему согласно ТЗ. Дать возможность
        пользователю исправить его ошибки. В конце концов потребуется
        повторная отправка прежних локальных изменений вместе с новыми
        будущими, либо их откат с помощью
        [запроса снапшота][api-snapshot].


[api-diff]: api/diff.md
[api-snapshot]: api/snapshot.md
[context]: 02-context.md
[limits]: 20-limitations.md
[workflow]: 04-workflow.md
